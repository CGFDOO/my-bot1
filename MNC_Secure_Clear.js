/**
 * â–ˆâ–€â–„â–€â–ˆ â–ˆâ–„ â–ˆ â–„â–€â–„  [ MNC IRON DOME - SECURE CLEAR ]
 * â–ˆ â–€ â–ˆ â–ˆ â–€â–ˆ â–ˆ â–„  [ HIGHER ADMINISTRATION ONLY ]
 * â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 * @security    Level 99 (Admin Only)
 * @protection  Anti-Crash & Input Validation
 * â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
 */

const { PermissionsBitField, EmbedBuilder } = require('discord.js');

module.exports = (client) => {
    client.on('messageCreate', async (message) => {
        try {
            // 1. ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¨ÙˆØªØ§Øª Ù„Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
            if (message.author.bot) return;

            // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
            const prefixes = ['!Ø­Ø°Ù', '!delete', '!Ù…Ø³Ø­', '!clear'];
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ¨Ø¯Ø£ Ø¨Ø£Ø­Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±ØŸ
            const prefix = prefixes.find(p => message.content.startsWith(p));
            if (!prefix) return;

            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø£Ø¬Ø²Ø§Ø¡ (Ø§Ù„Ø£Ù…Ø± + Ø§Ù„Ø±Ù‚Ù…)
            const args = message.content.slice(prefix.length).trim().split(/ +/);
            const amount = parseInt(args[0]);

            // =================================================================
            // ğŸ›¡ï¸ [ZONE 1] Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£ÙˆÙ„: ÙØ­Øµ Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø¹Ù„ÙŠØ§
            // =================================================================
            // Ù„Ø§Ø²Ù… Ø§Ù„Ø´Ø®Øµ ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯Ù‡ ØµÙ„Ø§Ø­ÙŠØ© "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„" Ø£Ùˆ "Ø£Ø¯Ù…Ù†"
            if (!message.member.permissions.has(PermissionsBitField.Flags.ManageMessages)) {
                // Ù„Ù† ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø¨ÙˆØª Ø¨ÙØ¹Ù„ Ø£ÙŠ Ø´ÙŠØ¡ (ØªØ¬Ø§Ù‡Ù„ ØªØ§Ù… Ù„Ù„Ù…ØªØ·ÙÙ„ÙŠÙ†)
                return; 
            }

            // =================================================================
            // ğŸ›¡ï¸ [ZONE 2] Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠ: ÙØ­Øµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
            // =================================================================
            // Ù„Ùˆ Ù…ÙÙŠØ´ Ø±Ù‚Ù…ØŒ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ù…Ø´ ØµØ­ÙŠØ­ØŒ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… ØµÙØ±.. ÙˆÙ‚Ù ÙÙˆØ±Ø§Ù‹
            if (!amount || isNaN(amount) || amount <= 0) {
                return message.reply('âš ï¸ **Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡Ø§! Ù…Ø«Ø§Ù„:** `!Ø­Ø°Ù 50`');
            }

            // Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø­Ø°Ù Ø£ÙƒØ«Ø± Ù…Ù† 100 Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
            if (amount > 100) {
                return message.reply('ğŸ›‘ **Ø­Ø¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ 100 Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©.**');
            }

            // =================================================================
            // â˜¢ï¸ [ZONE 3] Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¢Ù…Ù† (Safe Execution)
            // =================================================================
            // Ù†Ù‚ÙˆÙ… Ø¨Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ + Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£Ù…Ø± Ù†ÙØ³Ù‡Ø§ (Ù„Ø°Ù„Ùƒ Ù†Ø¬Ù…Ø¹ +1 Ù„Ù„Ø¹Ø¯Ø¯ Ù„ÙƒÙ† Ù„Ø§ Ù†ØªØ®Ø·Ù‰ 100)
            const deleteCount = Math.min(amount + 1, 100);

            await message.channel.bulkDelete(deleteCount, true)
                .then(deletedMessages => {
                    // Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
                    const embed = new EmbedBuilder()
                        .setColor('#00FF00') // Ø£Ø®Ø¶Ø± ÙŠØ¹Ù†ÙŠ Ù†Ø¬Ø§Ø­
                        .setDescription(`âœ… **ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!**\nğŸ—‘ï¸ **Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:** \`${deletedMessages.size - 1}\`\nğŸ‘® **Ø¨ÙˆØ§Ø³Ø·Ø©:** ${message.author}`)
                    
                    message.channel.send({ embeds: [embed] }).then(msg => {
                        // Ø¥Ø®ÙØ§Ø¡ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© (Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ø¹Ø¯ 4 Ø«ÙˆØ§Ù†ÙŠ)
                        setTimeout(() => msg.delete().catch(() => {}), 4000);
                    });
                })
                .catch(err => {
                    console.error('ğŸ”¥ [CLEAR ERROR]:', err);
                    message.reply('âš ï¸ **Ø­Ø¯Ø« Ø®Ø·Ø£!** Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ Ù…Ø± Ø¹Ù„ÙŠÙ‡Ø§ Ø£ÙƒØ«Ø± Ù…Ù† 14 ÙŠÙˆÙ…Ø§Ù‹ (Ù‚ÙˆØ§Ù†ÙŠÙ† Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯).');
                });

        } catch (error) {
            console.log('ğŸ›¡ï¸ [SYSTEM PROTECTED]: Prevented a crash.', error);
        }
    });
};

